openapi: 3.0.3
info:
  title: EdgePulse API
  version: 0.1.0
  description: |
    EdgePulse ingests time-series telemetry and produces anomaly scores and alerts.
servers:
  - url: http://localhost:8787
    description: Local Wrangler dev
  - url: https://api.example.com
    description: Production (replace with your domain)

tags:
  - name: Health
  - name: Ingestion
  - name: Devices
  - name: Metrics
  - name: Anomalies
  - name: Alerts
  - name: Webhooks

security:
  - ApiKeyAuth: []

paths:
  /v1/health:
    get:
      tags: [Health]
      security: []
      summary: Health check
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  /v1/ingest:
    post:
      tags: [Ingestion]
      summary: Ingest telemetry datapoints
      description: Validates payload, archives raw body to R2, enqueues for async normalisation.
      parameters:
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/IngestRequest"
      responses:
        "202":
          description: Accepted for processing
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IngestAcceptedResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /v1/devices:
    get:
      tags: [Devices]
      summary: List devices
      responses:
        "200":
          description: OK
    post:
      tags: [Devices]
      summary: Create a device
      responses:
        "201":
          description: Created

  /v1/metrics:
    get:
      tags: [Metrics]
      summary: List metrics
      responses:
        "200":
          description: OK
    post:
      tags: [Metrics]
      summary: Create a metric
      responses:
        "201":
          description: Created

  /v1/anomalies:
    get:
      tags: [Anomalies]
      summary: Query anomaly scores
      parameters:
        - name: metric_id
          in: query
          required: true
          schema: { type: string, format: uuid }
        - name: from
          in: query
          required: true
          schema: { type: string, format: date-time }
        - name: to
          in: query
          required: true
          schema: { type: string, format: date-time }
      responses:
        "200":
          description: OK

  /v1/alert-rules:
    get:
      tags: [Alerts]
      summary: List alert rules
      responses:
        "200":
          description: OK
    post:
      tags: [Alerts]
      summary: Create alert rule
      responses:
        "201":
          description: Created

  /v1/webhooks:
    get:
      tags: [Webhooks]
      summary: List webhooks
      responses:
        "200":
          description: OK
    post:
      tags: [Webhooks]
      summary: Create webhook
      responses:
        "201":
          description: Created

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key

  parameters:
    IdempotencyKey:
      name: Idempotency-Key
      in: header
      required: false
      schema:
        type: string
      description: Optional idempotency key for safe retries.

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Unauthorized:
      description: Missing/invalid API key
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

  schemas:
    HealthResponse:
      type: object
      properties:
        ok: { type: boolean }
        service: { type: string }
        ts: { type: string, format: date-time }
      required: [ok, service, ts]

    IngestRequest:
      type: object
      properties:
        device_external_id:
          type: string
          minLength: 1
        metrics:
          type: array
          minItems: 1
          items:
            $ref: "#/components/schemas/MetricPoint"
      required: [device_external_id, metrics]

    MetricPoint:
      type: object
      properties:
        name: { type: string, minLength: 1 }
        ts: { type: string, format: date-time }
        value: { type: number }
        unit: { type: string }
      required: [name, ts, value]

    IngestAcceptedResponse:
      type: object
      properties:
        batch_id: { type: string, format: uuid }
        r2_key: { type: string }
        status: { type: string, enum: [accepted] }
      required: [batch_id, r2_key, status]

    ErrorResponse:
      type: object
      properties:
        error: { type: string }
        details:
          type: object
          additionalProperties: true
      required: [error]
